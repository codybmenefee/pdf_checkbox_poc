<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Field Visualization - PDF Checkbox Extraction System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .document-container {
            position: relative;
            margin-top: 20px;
            border: 1px solid #ccc;
            overflow: hidden;
        }
        .document-container.rectangle-select-mode {
            cursor: crosshair;
            background-color: rgba(0, 123, 255, 0.05);
        }
        #selectionRectangle {
            position: absolute;
            border: 1px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            z-index: 5;
            pointer-events: none;
        }
        .field-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .field-marker {
            position: absolute;
            border: 2px solid;
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: auto;
            min-width: 15px;
            min-height: 15px;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        .field-marker:hover {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
        }
        .field-marker.selected {
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.7);
            border-width: 3px;
            z-index: 15;
        }
        .field-marker.active-drag {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 0 12px rgba(0, 123, 255, 0.8);
            z-index: 20;
        }
        .field-marker.active-resize {
            opacity: 0.8;
            box-shadow: 0 0 12px rgba(220, 53, 69, 0.8);
            z-index: 20;
        }
        .field-marker.overlap-warning {
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.8);
            animation: pulse-warning 1s infinite;
        }
        @keyframes pulse-warning {
            0% { box-shadow: 0 0 12px rgba(255, 193, 7, 0.5); }
            50% { box-shadow: 0 0 14px rgba(255, 193, 7, 0.8); }
            100% { box-shadow: 0 0 12px rgba(255, 193, 7, 0.5); }
        }
        .field-text {
            border-color: rgba(40, 167, 69, 0.8);
            background-color: rgba(40, 167, 69, 0.2);
        }
        .field-checkbox {
            border-color: rgba(0, 123, 255, 0.8);
            background-color: rgba(0, 123, 255, 0.2);
        }
        .field-signature {
            border-color: rgba(220, 53, 69, 0.8);
            background-color: rgba(220, 53, 69, 0.2);
        }
        .field-date {
            border-color: rgba(255, 193, 7, 0.8);
            background-color: rgba(255, 193, 7, 0.2);
        }
        .field-label {
            position: absolute;
            top: -24px;
            left: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 20;
            transition: opacity 0.2s ease;
        }
        .field-marker:hover .field-label {
            opacity: 1;
        }
        .checkbox-content {
            font-size: 16px;
            font-weight: bold;
        }
        .checked {
            color: #28a745;
        }
        .unchecked {
            color: #dc3545;
        }
        .debug-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            z-index: 30;
            border-radius: 4px;
            max-width: 50%;
            backdrop-filter: blur(2px);
        }
        .debug-info {
            position: absolute;
            bottom: -18px;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 1px 3px;
            font-size: 9px;
            border-radius: 2px;
        }
        .controls {
            margin-bottom: 20px;
        }
        .page-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 50%;
            z-index: 25;
        }
        .resize-handle:hover {
            background-color: #007bff;
            border-color: #0056b3;
        }
        .handle-tl {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }
        .handle-tr {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }
        .handle-bl {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }
        .handle-br {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }
        .keyboard-shortcuts {
            margin-top: 20px;
            font-size: 12px;
        }
        .keyboard-shortcuts kbd {
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
            color: #333;
            display: inline-block;
            font-size: 11px;
            line-height: 1.4;
            margin: 0 2px;
            padding: 2px 4px;
        }
        .field-type-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 5px;
            vertical-align: middle;
        }
        /* Batch Operation Styles */
        .batch-operation-active .field-marker.selected {
            animation: pulse-selection 1s infinite;
        }
        @keyframes pulse-selection {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        .batch-align-indicator {
            position: absolute;
            background-color: rgba(0, 123, 255, 0.2);
            border: 1px dashed rgba(0, 123, 255, 0.7);
            z-index: 5;
            pointer-events: none;
        }
        .batch-align-indicator.horizontal {
            height: 1px;
            left: 0;
            right: 0;
            border-top: 1px dashed rgba(0, 123, 255, 0.7);
            border-bottom: none;
        }
        .batch-align-indicator.vertical {
            width: 1px;
            top: 0;
            bottom: 0;
            border-left: 1px dashed rgba(0, 123, 255, 0.7);
            border-right: none;
        }
        /* Table styles for selected fields */
        .field-table tbody tr.selected {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .field-table tbody tr.selected:hover {
            background-color: rgba(0, 123, 255, 0.2);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">PDF Checkbox Extraction System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/ui/templates">Templates</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ui/forms">Forms</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1>Template Field Visualization</h1>
                <p class="lead"><span id="templateName">Loading template...</span></p>
            </div>
            <div class="col-auto">
                <a href="/ui/templates" class="btn btn-secondary">Back to Templates</a>
            </div>
        </div>

        <div class="row">
            <!-- Controls sidebar -->
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Display Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="toggleFieldOverlay" checked>
                            <label class="form-check-label" for="toggleFieldOverlay">Show Field Overlays</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="toggleFieldLabels" checked>
                            <label class="form-check-label" for="toggleFieldLabels">Show Field Labels</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="toggleDebugMode">
                            <label class="form-check-label" for="toggleDebugMode">Debug Mode</label>
                        </div>
                        <hr>
                        <h6>Field Size Adjustment</h6>
                        <div class="d-flex mb-2">
                            <button id="decreaseSize" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="bi bi-dash"></i>
                            </button>
                            <div id="sizeMultiplier" class="flex-grow-1 text-center">Size: 1.0x</div>
                            <button id="increaseSize" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <button id="resetSize" class="btn btn-sm btn-outline-secondary w-100 mb-3">Reset Size</button>
                        
                        <h6>Field Type Filter</h6>
                        <div id="fieldTypeFilters">
                            <!-- Field type filter checkboxes will be added here dynamically -->
                        </div>
                        
                        <hr>
                        <div id="templateSummary">
                            <!-- Template summary will be added here -->
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Template Details</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <th>Template ID</th>
                                <td id="templateId">Loading...</td>
                            </tr>
                            <tr>
                                <th>Version</th>
                                <td id="templateVersion">Loading...</td>
                            </tr>
                            <tr>
                                <th>Fields</th>
                                <td id="fieldCount">Loading...</td>
                            </tr>
                        </table>
                        
                        <button id="saveChangesBtn" class="btn btn-primary w-100 mb-2">Save Changes</button>
                        <button id="exportJsonBtn" class="btn btn-secondary w-100">Export JSON</button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Keyboard Shortcuts</h5>
                    </div>
                    <div class="card-body">
                        <div class="keyboard-shortcuts">
                            <div><kbd>←</kbd> <kbd>→</kbd> Navigate pages</div>
                            <div><kbd>O</kbd> Toggle overlays</div>
                            <div><kbd>L</kbd> Toggle labels</div>
                            <div><kbd>D</kbd> Toggle debug mode</div>
                            <div><kbd>A</kbd> Select all fields</div>
                            <div><kbd>Esc</kbd> Deselect all</div>
                            <div><kbd>Del</kbd> Delete selected</div>
                            <div><kbd>+</kbd> <kbd>-</kbd> Zoom in/out</div>
                            <div><kbd>Ctrl</kbd>+<kbd>S</kbd> Save changes</div>
                            <div><kbd>Shift</kbd>+Click: Multi-select</div>
                        </div>
                    </div>
                </div>
                
                <div id="debugInfo" class="card mb-4" style="display: none;">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="debug-content">
                            <!-- Debug information will be added here -->
                            <div class="mb-2">
                                <strong>Field Details:</strong>
                                <pre id="selectedFieldDetails" class="bg-light p-2 mt-1" style="font-size: 10px;">No field selected</pre>
                            </div>
                            <div class="mb-2">
                                <strong>Cursor Position:</strong>
                                <div id="docCursorPos">0,0 (0.000,0.000)</div>
                            </div>
                            <div class="mb-2">
                                <strong>Image Dimensions:</strong>
                                <div id="imageSize">0x0</div>
                            </div>
                            <div>
                                <strong>Selection:</strong>
                                <div id="selectionInfo">No fields selected</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="batchOperations" class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Batch Operations</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted d-block mb-2">Selection: Hold Ctrl and drag to select multiple fields</small>
                            <button id="selectAll" class="btn btn-sm btn-outline-secondary me-1">Select All</button>
                            <button id="deselectAll" class="btn btn-sm btn-outline-secondary">Deselect All</button>
                        </div>
                        
                        <div class="mb-3">
                            <strong class="d-block mb-2">Alignment</strong>
                            <div class="btn-group w-100">
                                <button id="batchAlignLeft" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-align-start"></i> Left
                                </button>
                                <button id="batchAlignRight" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-align-end"></i> Right
                                </button>
                                <button id="batchAlignTop" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-align-top"></i> Top
                                </button>
                                <button id="batchAlignBottom" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-align-bottom"></i> Bottom
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong class="d-block mb-2">Distribution</strong>
                            <div class="btn-group w-100">
                                <button id="batchDistributeHorizontal" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-distribute-horizontal"></i> Horizontal
                                </button>
                                <button id="batchDistributeVertical" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-distribute-vertical"></i> Vertical
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong class="d-block mb-2">Same Size</strong>
                            <div class="btn-group w-100">
                                <button id="batchSameWidth" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrows-expand-horizontal"></i> Width
                                </button>
                                <button id="batchSameHeight" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrows-expand-vertical"></i> Height
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Document visualization area -->
            <div class="col-md-9">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="page-controls">
                            <button id="prevPage" class="btn btn-sm btn-secondary" disabled>
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                            <span id="pageInfo">Page 1 of 1</span>
                            <button id="nextPage" class="btn btn-sm btn-secondary" disabled>
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="document-container">
                            <img id="documentImage" class="img-fluid w-100" src="/static/images/loading-placeholder.png" alt="Document page">
                            <div id="fieldOverlay" class="field-overlay"></div>
                            <div id="debugOverlay" class="debug-overlay" style="display: none;">
                                Cursor: <span id="cursorPos">0,0</span> | 
                                Image: <span id="imageSize">0x0</span>
                            </div>
                            <div id="errorBox" style="display: none; position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px; background-color: rgba(255, 0, 0, 0.2); border: 1px solid red; color: red; z-index: 1000;">
                                Error loading document visualization
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Fields on Current Page</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Field ID</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Default Value</th>
                                    </tr>
                                </thead>
                                <tbody id="fieldTableBody">
                                    <!-- Field rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let templateData = null;
        let currentPage = 1;
        let totalPages = 1;
        let sizeMultiplier = 1.0;
        let showLabels = true;
        let showDebug = false;
        let showOverlay = true;
        let imageLoaded = false;
        let fieldTypeFilters = {};
        
        // DOM Elements
        const templateNameElement = document.getElementById('templateName');
        const templateIdElement = document.getElementById('templateId');
        const templateVersionElement = document.getElementById('templateVersion');
        const fieldCountElement = document.getElementById('fieldCount');
        const templateSummaryElement = document.getElementById('templateSummary');
        const documentImage = document.getElementById('documentImage');
        const fieldOverlay = document.getElementById('fieldOverlay');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');
        const pageInfoElement = document.getElementById('pageInfo');
        const toggleFieldOverlayCheckbox = document.getElementById('toggleFieldOverlay');
        const toggleFieldLabelsCheckbox = document.getElementById('toggleFieldLabels');
        const toggleDebugModeCheckbox = document.getElementById('toggleDebugMode');
        const increaseSizeBtn = document.getElementById('increaseSize');
        const decreaseSizeBtn = document.getElementById('decreaseSize');
        const resetSizeBtn = document.getElementById('resetSize');
        const sizeMultiplierElement = document.getElementById('sizeMultiplier');
        const fieldTableBody = document.getElementById('fieldTableBody');
        const fieldTypeFiltersElement = document.getElementById('fieldTypeFilters');
        const debugInfoElement = document.getElementById('debugInfo');
        const debugContentElement = document.querySelector('.debug-content');
        const debugOverlay = document.getElementById('debugOverlay');
        const cursorPosElement = document.getElementById('cursorPos');
        const imageSizeElement = document.getElementById('imageSize');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        
        // Get template ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('template_id');
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            if (!templateId) {
                alert('No template ID provided. Please select a template first.');
                window.location.href = '/ui/templates';
                return;
            }
            
            // Load template data
            loadTemplateData(templateId);
            
            // Event listeners
            toggleFieldOverlayCheckbox.addEventListener('change', toggleFieldOverlay);
            toggleFieldLabelsCheckbox.addEventListener('change', toggleFieldLabels);
            toggleDebugModeCheckbox.addEventListener('change', toggleDebugMode);
            increaseSizeBtn.addEventListener('click', () => adjustSize(0.1));
            decreaseSizeBtn.addEventListener('click', () => adjustSize(-0.1));
            resetSizeBtn.addEventListener('click', resetSize);
            prevPageButton.addEventListener('click', goToPreviousPage);
            nextPageButton.addEventListener('click', goToNextPage);
            documentImage.addEventListener('load', onImageLoaded);
            saveChangesBtn.addEventListener('click', saveChanges);
            exportJsonBtn.addEventListener('click', exportTemplateJson);
            
            // Mouse position tracking for debug overlay
            documentImage.addEventListener('mousemove', trackMousePosition);
        });
        
        // Load template data
        function loadTemplateData(templateId) {
            fetch(`/api/templates/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    templateData = data.template;
                    displayTemplateInfo(templateData);
                    updateFieldTypeFilters(templateData.fields);
                    loadPage(currentPage);
                })
                .catch(error => {
                    console.error('Error loading template data:', error);
                    alert('Error loading template: ' + error.message);
                });
        }
        
        // Display template information
        function displayTemplateInfo(template) {
            templateNameElement.textContent = template.name;
            templateIdElement.textContent = template.template_id;
            templateVersionElement.textContent = template.version;
            fieldCountElement.textContent = template.fields.length;
            
            // Count fields by type
            const fieldTypeCounts = {};
            template.fields.forEach(field => {
                const type = field.field_type || 'unknown';
                fieldTypeCounts[type] = (fieldTypeCounts[type] || 0) + 1;
            });
            
            // Display field type summary
            let summaryHtml = '<h6>Field Types</h6><ul class="list-unstyled">';
            Object.entries(fieldTypeCounts).forEach(([type, count]) => {
                summaryHtml += `<li><span class="badge bg-secondary">${type}: ${count}</span></li>`;
            });
            summaryHtml += '</ul>';
            
            templateSummaryElement.innerHTML = summaryHtml;
            
            // Calculate total pages from template data
            const pageNumbers = [...new Set(template.fields.map(field => field.page))];
            totalPages = Math.max(...pageNumbers, 1);
            
            // Update page navigation
            updatePageNavigation();
        }
        
        // Update field type filters
        function updateFieldTypeFilters(fields) {
            const fieldTypes = [...new Set(fields.map(field => field.field_type || 'unknown'))];
            
            // Initialize all filters to true (checked)
            fieldTypes.forEach(type => {
                fieldTypeFilters[type] = true;
            });
            
            // Build filter checkboxes
            let filtersHtml = '';
            fieldTypes.forEach(type => {
                filtersHtml += `
                    <div class="form-check">
                        <input class="form-check-input field-type-filter" type="checkbox" id="filter_${type}" data-type="${type}" checked>
                        <label class="form-check-label" for="filter_${type}">${type}</label>
                    </div>
                `;
            });
            
            fieldTypeFiltersElement.innerHTML = filtersHtml;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.field-type-filter').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const fieldType = this.getAttribute('data-type');
                    fieldTypeFilters[fieldType] = this.checked;
                    renderFields();
                });
            });
        }
        
        // Load a specific page
        function loadPage(pageNumber) {
            if (!templateData) return;
            
            currentPage = pageNumber;
            updatePageNavigation();
            
            // Show loading placeholder
            documentImage.src = '/static/images/loading-placeholder.png';
            fieldOverlay.innerHTML = '';
            document.getElementById('errorBox').style.display = 'none';
            
            // Fetch the PDF page visualization
            const visualizationUrl = `/api/templates/${templateData.template_id}/visualize?page=${pageNumber}`;
            
            console.log(`Fetching visualization from ${visualizationUrl}`);
            
            fetch(visualizationUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Visualization API response:', data);
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Get the image URL for the current page
                    const pageData = data.pages.find(p => p.page_number === pageNumber);
                    
                    if (!pageData) {
                        throw new Error(`Page ${pageNumber} not found in visualization data`);
                    }
                    
                    console.log('Page data for visualization:', pageData);
                    
                    // Check if there's an error in the page data
                    if (pageData.error) {
                        const errorBox = document.getElementById('errorBox');
                        errorBox.textContent = `Error: ${pageData.error}`;
                        errorBox.style.display = 'block';
                        console.error(`Error in page data: ${pageData.error}`);
                        // Still try to show the image if available
                    }
                    
                    // Add timestamp to URLs to prevent caching
                    const timestamp = new Date().getTime();
                    
                    // Use either the primary or alternate URL, whichever works
                    const possibleUrls = [
                        pageData.image_url + `?t=${timestamp}`,
                        pageData.alternate_url + `?t=${timestamp}`,
                        `/static/visualizations/${templateData.template_id}/page_${pageNumber}.png?t=${timestamp}`,
                        `/static/visualizations/${templateData.template_id}/page_${pageNumber}.jpg?t=${timestamp}`,
                        `/api/visualizations/${templateData.template_id}/page_${pageNumber}.png?t=${timestamp}`,
                        `/api/visualizations/${templateData.template_id}/page_${pageNumber}.jpg?t=${timestamp}`
                    ].filter(url => url); // Remove undefined/null entries
                    
                    console.log("Possible image URLs:", possibleUrls);

                    // First try the direct check endpoint to see if the image exists
                    fetch(`/static_debug?template_id=${templateData.template_id}`)
                        .then(response => response.json())
                        .then(debugData => {
                            console.log('Static debug data:', debugData);
                            
                            // Now load the image with our possible URLs
                            loadImageWithFallbacks(possibleUrls);
                            
                            // Update field table
                            updateFieldTable(pageNumber);
                        })
                        .catch(error => {
                            console.error('Error checking static debug:', error);
                            // Try to load the image anyway
                            loadImageWithFallbacks(possibleUrls);
                            updateFieldTable(pageNumber);
                        });
                })
                .catch(error => {
                    console.error('Error loading visualization:', error);
                    documentImage.src = '/static/images/error-placeholder.png';
                    fieldOverlay.innerHTML = '';
                    const errorBox = document.getElementById('errorBox');
                    errorBox.textContent = `Error: ${error.message}`;
                    errorBox.style.display = 'block';
                    fieldTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center">Error loading page: ${error.message}</td>
                        </tr>
                    `;
                });
        }
        
        // Load image with fallbacks
        function loadImageWithFallbacks(urls) {
            imageLoaded = false;
            let currentUrlIndex = 0;
            let allUrlsFailed = true;
            
            console.log("Trying to load image with URLs:", urls);
            
            function tryLoadImage() {
                if (currentUrlIndex >= urls.length) {
                    console.error('All image URLs failed to load');
                    documentImage.src = '/static/images/error-placeholder.png';
                    const errorBox = document.getElementById('errorBox');
                    if (allUrlsFailed) {
                        errorBox.textContent = 'Failed to load document image from any URL';
                        errorBox.style.display = 'block';
                        
                        // As a last resort, try to force regenerate the visualization
                        const regenerateUrl = `/test_pdf_viz/${templateData.template_id}`;
                        console.log(`Attempting to regenerate visualization: ${regenerateUrl}`);
                        
                        fetch(regenerateUrl)
                            .then(response => response.json())
                            .then(data => {
                                console.log('Regeneration response:', data);
                                if (!data.error) {
                                    // Try loading the page again after a short delay
                                    setTimeout(() => {
                                        loadPage(currentPage);
                                    }, 1000);
                                }
                            })
                            .catch(error => {
                                console.error('Error regenerating visualization:', error);
                            });
                    }
                    return;
                }
                
                const url = urls[currentUrlIndex];
                console.log(`Attempting to load image from: ${url}`);
                
                // First check if the URL is accessible by making a HEAD request
                fetch(url, { method: 'HEAD' })
                    .then(response => {
                        console.log(`HEAD request for ${url}: ${response.status}`);
                        if (!response.ok) {
                            throw new Error(`HEAD request failed: ${response.status}`);
                        }
                        return response;
                    })
                    .then(response => {
                        console.log(`Content type: ${response.headers.get('content-type')}`);
                        
                        // Create a new Image object to load the image
                        const testImg = new Image();
                        testImg.crossOrigin = "Anonymous";
                        
                        testImg.onload = function() {
                            console.log(`Successfully loaded image from ${url}`);
                            allUrlsFailed = false;
                            documentImage.src = url;
                            document.getElementById('errorBox').style.display = 'none';
                            
                            // Mark as loaded to trigger field rendering
                            setTimeout(() => {
                                imageLoaded = true;
                                onImageLoaded();
                            }, 100);
                        };
                        
                        testImg.onerror = function(e) {
                            console.warn(`Failed to load image from ${url}`, e);
                            currentUrlIndex++;
                            tryLoadImage();
                        };
                        
                        // Add timestamp to prevent caching
                        testImg.src = url;
                    })
                    .catch(error => {
                        console.warn(`Failed to access ${url}: ${error.message}`);
                        currentUrlIndex++;
                        tryLoadImage();
                    });
            }
            
            // Start loading process
            tryLoadImage();
        }
        
        // Handle image loaded
        function onImageLoaded() {
            const width = documentImage.naturalWidth || documentImage.clientWidth;
            const height = documentImage.naturalHeight || documentImage.clientHeight;
            
            console.log(`Image loaded dimensions: ${width}x${height}`);
            
            // Update image size info
            if (width > 0 && height > 0) {
                console.log(`Image loaded successfully with dimensions: ${width}x${height}`);
                imageSizeElement.textContent = `${width}x${height}`;
                
                // Adjust field overlay to match image dimensions
                fieldOverlay.style.width = `${width}px`;
                fieldOverlay.style.height = `${height}px`;
                
                // Make container match image size
                const container = document.querySelector('.document-container');
                if (container) {
                    container.style.width = `${width}px`;
                    container.style.height = `${height}px`;
                    container.style.maxWidth = '100%';
                }
                
                // Now render fields
                renderFields();
            } else {
                console.error("Image loaded with invalid dimensions");
                const errorBox = document.getElementById('errorBox');
                errorBox.textContent = 'Document loaded with invalid dimensions';
                errorBox.style.display = 'block';
                
                setTimeout(() => {
                    onImageLoaded();
                }, 100);
            }
        }
        
        // Update page navigation
        function updatePageNavigation() {
            prevPageButton.disabled = currentPage <= 1;
            nextPageButton.disabled = currentPage >= totalPages;
            pageInfoElement.textContent = `Page ${currentPage} of ${totalPages}`;
        }
        
        // Go to previous page
        function goToPreviousPage() {
            if (currentPage > 1) {
                loadPage(currentPage - 1);
            }
        }
        
        // Go to next page
        function goToNextPage() {
            if (currentPage < totalPages) {
                loadPage(currentPage + 1);
            }
        }
        
        // Render fields for the current page
        function renderFields() {
            if (!templateData || !imageLoaded) return;
            
            // Clear existing overlay
            fieldOverlay.innerHTML = '';
            
            // Get image dimensions
            const docWidth = documentImage.clientWidth;
            const docHeight = documentImage.clientHeight;
            
            // Find fields for the current page
            const pageFields = templateData.fields.filter(field => 
                field.page === currentPage && fieldTypeFilters[field.field_type || 'unknown']
            );
            
            // Log field count to debug
            updateDebugInfo(`Rendering ${pageFields.length} fields for page ${currentPage}`);
            
            // Render each field
            pageFields.forEach(field => {
                const bbox = field.bbox || {};
                
                // Skip if no bounding box
                if (!bbox) return;
                
                // Calculate position and size
                const left = bbox.left * docWidth;
                const top = bbox.top * docHeight;
                const width = (bbox.width || 0.03) * docWidth * sizeMultiplier;
                const height = (bbox.height || 0.03) * docHeight * sizeMultiplier;
                
                // Create marker element
                const marker = document.createElement('div');
                marker.classList.add('field-marker');
                marker.classList.add(`field-${field.field_type || 'other'}`);
                marker.dataset.fieldId = field.field_id;
                
                // Set position and size
                marker.style.left = `${left}px`;
                marker.style.top = `${top}px`;
                marker.style.width = `${width}px`;
                marker.style.height = `${height}px`;
                
                // Set visibility based on overlay toggle
                marker.style.display = showOverlay ? 'flex' : 'none';
                
                // Add checkbox content if it's a checkbox
                if (field.field_type === 'checkbox') {
                    const checkContent = document.createElement('span');
                    checkContent.classList.add('checkbox-content');
                    checkContent.classList.add(field.default_value ? 'checked' : 'unchecked');
                    checkContent.textContent = field.default_value ? '✓' : '✗';
                    marker.appendChild(checkContent);
                }
                
                // Add label
                const label = document.createElement('div');
                label.classList.add('field-label');
                label.textContent = field.label || field.name || field.field_id;
                label.style.display = showLabels ? 'block' : 'none';
                marker.appendChild(label);
                
                // Add debug info
                if (showDebug) {
                    const debug = document.createElement('div');
                    debug.classList.add('field-debug');
                    debug.style.position = 'absolute';
                    debug.style.bottom = '-16px';
                    debug.style.left = '0';
                    debug.style.fontSize = '9px';
                    debug.style.backgroundColor = 'rgba(0,0,0,0.7)';
                    debug.style.color = 'white';
                    debug.style.padding = '1px 3px';
                    debug.textContent = `${left.toFixed(0)},${top.toFixed(0)} ${width.toFixed(0)}x${height.toFixed(0)}`;
                    marker.appendChild(debug);
                }
                
                // Add to overlay
                fieldOverlay.appendChild(marker);
            });
        }
        
        // Update field table for the current page
        function updateFieldTable(pageNumber) {
            if (!templateData) return;
            
            // Find fields for the current page
            const pageFields = templateData.fields.filter(field => field.page === pageNumber);
            
            // Clear existing table
            fieldTableBody.innerHTML = '';
            
            if (pageFields.length === 0) {
                fieldTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No fields on this page</td>
                    </tr>
                `;
                return;
            }
            
            // Add field rows
            pageFields.forEach(field => {
                // Format default value based on field type
                let formattedValue = '';
                if (field.field_type === 'checkbox') {
                    formattedValue = field.default_value ? 'Checked' : 'Unchecked';
                } else {
                    formattedValue = field.default_value || '(Empty)';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${field.field_id}</td>
                    <td>${field.label || field.name || '(Unnamed)'}</td>
                    <td>${field.field_type || 'unknown'}</td>
                    <td>${formattedValue}</td>
                `;
                fieldTableBody.appendChild(row);
            });
        }
        
        // Toggle field overlay
        function toggleFieldOverlay() {
            showOverlay = toggleFieldOverlayCheckbox.checked;
            
            const markers = document.querySelectorAll('.field-marker');
            markers.forEach(marker => {
                marker.style.display = showOverlay ? 'flex' : 'none';
            });
            
            updateDebugInfo(`Field overlay ${showOverlay ? 'shown' : 'hidden'}`);
        }
        
        // Toggle field labels
        function toggleFieldLabels() {
            showLabels = toggleFieldLabelsCheckbox.checked;
            
            const labels = document.querySelectorAll('.field-label');
            labels.forEach(label => {
                label.style.display = showLabels ? 'block' : 'none';
            });
            
            updateDebugInfo(`Field labels ${showLabels ? 'shown' : 'hidden'}`);
        }
        
        // Toggle debug mode
        function toggleDebugMode() {
            showDebug = toggleDebugModeCheckbox.checked;
            
            debugInfoElement.style.display = showDebug ? 'block' : 'none';
            debugOverlay.style.display = showDebug ? 'block' : 'none';
            
            // Re-render fields to show/hide debug info
            renderFields();
        }
        
        // Adjust the size of field markers
        function adjustSize(change) {
            sizeMultiplier += change;
            if (sizeMultiplier < 0.1) sizeMultiplier = 0.1;
            if (sizeMultiplier > 5) sizeMultiplier = 5;
            
            sizeMultiplierElement.textContent = `Size: ${sizeMultiplier.toFixed(1)}x`;
            
            // Re-render with new size
            renderFields();
            
            updateDebugInfo(`Size adjusted to ${sizeMultiplier.toFixed(1)}x`);
        }
        
        // Reset the size of field markers
        function resetSize() {
            sizeMultiplier = 1.0;
            sizeMultiplierElement.textContent = `Size: ${sizeMultiplier.toFixed(1)}x`;
            
            // Re-render with default size
            renderFields();
            
            updateDebugInfo('Size reset to default');
        }
        
        // Track mouse position for debug overlay
        function trackMousePosition(e) {
            if (!showDebug) return;
            
            const rect = documentImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (x >= 0 && y >= 0 && x <= rect.width && y <= rect.height) {
                const normalizedX = (x / rect.width).toFixed(3);
                const normalizedY = (y / rect.height).toFixed(3);
                cursorPosElement.textContent = `${x.toFixed(0)},${y.toFixed(0)} (${normalizedX},${normalizedY})`;
            }
        }
        
        // Update debug information
        function updateDebugInfo(message) {
            if (!showDebug) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<small>${timestamp}: ${message}</small>`;
            
            debugContentElement.prepend(entry);
            
            // Limit the number of debug messages
            if (debugContentElement.children.length > 10) {
                debugContentElement.lastChild.remove();
            }
        }
        
        // Save changes to template
        function saveChanges() {
            if (!templateData) return;
            
            // Collect the updated field data
            const updatedFields = [];
            for (const field of allFields) {
                // Find the DOM element if it has been modified
                const fieldElement = document.querySelector(`.field-marker[data-field-id="${field.field_id}"]`);
                if (fieldElement) {
                    // Get the position from the element
                    const rect = fieldElement.getBoundingClientRect();
                    const imgRect = documentImage.getBoundingClientRect();
                    
                    // Calculate normalized position
                    const left = (rect.left - imgRect.left) / imgRect.width;
                    const top = (rect.top - imgRect.top) / imgRect.height;
                    const width = rect.width / imgRect.width;
                    const height = rect.height / imgRect.height;
                    
                    // Update field with new position
                    const updatedField = {
                        ...field,
                        bbox: {
                            left: parseFloat(left.toFixed(4)),
                            top: parseFloat(top.toFixed(4)),
                            width: parseFloat(width.toFixed(4)),
                            height: parseFloat(height.toFixed(4)),
                            // Also include right and bottom for compatibility
                            right: parseFloat((left + width).toFixed(4)),
                            bottom: parseFloat((top + height).toFixed(4))
                        }
                    };
                    updatedFields.push(updatedField);
                } else {
                    // If not modified, use original field
                    updatedFields.push(field);
                }
            }
            
            // Prepare data for saving
            const saveData = {
                template_id: templateData.template_id,
                fields: updatedFields,
                version: parseFloat(templateData.version) + 0.1
            };
            
            // Send to server
            fetch('/api/template/save-field-positions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(saveData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('Error saving changes: ' + data.error, 'error');
                    updateDebugInfo('Save failed: ' + data.error);
                } else {
                    showToast('Changes saved successfully', 'success');
                    updateDebugInfo('Changes saved successfully');
                    
                    // Update version if returned in response
                    if (data.version) {
                        templateData.version = data.version;
                        document.getElementById('templateVersion').textContent = data.version;
                    }
                }
            })
            .catch(error => {
                showToast('Error saving changes: ' + error.message, 'error');
                updateDebugInfo('Save error: ' + error.message);
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${type === 'error' ? 'bg-danger text-white' : 
                                            type === 'success' ? 'bg-success text-white' : 'bg-primary text-white'}">
                        <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            // Add toast to container
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Initialize and show toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();
        }
        
        // Export template as JSON
        function exportTemplateJson() {
            if (!templateData) return;
            
            // Create JSON string with pretty formatting
            const jsonStr = JSON.stringify(templateData, null, 2);
            
            // Create a blob and download link
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `template_${templateData.template_id}.json`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            updateDebugInfo('Template exported as JSON');
        }
    </script>
</body>
</html> 